#cloud-config

users:
  - name: runner
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: docker

package_update: true
package_upgrade: true

packages:
  - docker.io
  - build-essential
  - curl
  - git
  - jq
  - unzip
  - libffi-dev
  - libssl-dev
  - zlib1g-dev

runcmd:
  - systemctl enable docker
  - systemctl start docker

  # Install Ruby 3.3 via ruby-install
  - curl -fsSL https://github.com/postmodern/ruby-install/releases/download/v0.9.3/ruby-install-0.9.3.tar.gz | tar -xz -C /tmp
  - cd /tmp/ruby-install-0.9.3 && make install
  - ruby-install --system ruby 3.3
  - gem install bundler

  # Install Chef Workstation
  - curl -fsSL https://omnitruck.chef.io/install.sh | bash -s -- -P chef-workstation

  # Set up runner
  - mkdir -p /home/runner/actions-runner
  - cd /home/runner/actions-runner
  - 'curl -fsSL -o actions-runner.tar.gz "https://github.com/actions/runner/releases/download/v{{.RunnerVersion}}/actions-runner-linux-x64-{{.RunnerVersion}}.tar.gz"'
  - tar xzf actions-runner.tar.gz
  - chown -R runner:runner /home/runner/actions-runner

  # Configure and start ephemeral runner
  - |
    su - runner -c "cd /home/runner/actions-runner && \
      ./config.sh \
        --url https://github.com/{{.RunnerRepo}} \
        --token {{.RunnerToken}} \
        --name {{.RunnerName}} \
        --labels {{.RunnerLabels}} \
        --ephemeral \
        --unattended && \
      ./run.sh"

  # Self-destruct after job completes
  - |
    DROPLET_ID=$(curl -s http://169.254.169.254/metadata/v1/id)
    curl -s -X DELETE \
      -H "Authorization: Bearer {{.DOToken}}" \
      "https://api.digitalocean.com/v2/droplets/${DROPLET_ID}"
